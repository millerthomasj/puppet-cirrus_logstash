filter {
  if [type] == "ceph_format" {
    if "cephmon" in [fields][tags] {
      if "ceph" in [fields][tags] { mutate { add_tag => [ "ceph" ] } }
      if "ceph_audit" in [fields][tags] { mutate { add_tag => [ "ceph_audit" ] } }
      if "ceph_mon" in [fields][tags] { mutate { add_tag => [ "ceph_mon" ] } }
      if "ceph_osd" in [fields][tags] { mutate { add_tag => [ "ceph_osd" ] } }

      mutate { add_tag => [ "cephmon" ] }
    }

    if "ceph_mon" in [fields][tags] or "ceph_osd" in [fields][tags] {
      grok {
        match => { "message" => "^%{TIMESTAMP_ISO8601:logdate}%{SPACE}%{DATA:thread_id}?%{SPACE}%{NUMBER:loglevel}%{SPACE}%{GREEDYDATA:module}${SPACE}:${SPACE}%{GREEDYDATA:logmessage}?" }
        add_field => { "received_at" => "%{@timestamp}" }
      }
    } else {
      grok {
        match => { "message" => "^%{TIMESTAMP_ISO8601:logdate}%{SPACE}%{DATA:mon_name}%{SPACE}%{IP:client}:%{INT:port}/%{INT:loglevel}%{SPACE}%{INT:pid}${SPACE}:${SPACE}%{GREEDYDATA:logmessage}?" }
        add_field => { "received_at" => "%{@timestamp}" }
      }
    }
    <% if scope.lookupvar('cirrus_logstash::openstack_filters_allow_debug') == false %>
    # Remove DEBUG logs to reduce the amount of data that needs to be processed.
    if [loglevel] == "DEBUG" {
      drop {}
    }
    <% end %>

    if ! ("_grokparsefailure" in [tags]) {
      mutate {
        lowercase => [ "loglevel" ]
        remove_tag => [ "beats_input_codec_plain_applied" ]
        remove_field => [ "offset", "count", "input_type", "beat", "logdate", "[fields][tags]" ]
        convert => { "pid" => "integer" }
        rename => { "host" => "hostname" }
        rename => { "logmessage" => "message" }
      }
    }
  }
}
